apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "qualys-ca.fullname" . }}
  namespace: {{ .Values.namespace.name }}
  labels:
    {{- include "qualys-ca.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      {{- include "qualys-ca.selectorLabels" . | nindent 6 }}
  updateStrategy:
    {{- toYaml .Values.updateStrategy | nindent 4 }}
  template:
    metadata:
      labels:
        {{- include "qualys-ca.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ include "qualys-ca.serviceAccountName" . }}
      automountServiceAccountToken: false
      hostPID: true
      hostNetwork: false
      priorityClassName: {{ .Values.priorityClassName | default "system-node-critical" }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: qualys-agent-installer
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        securityContext:
          privileged: true
          runAsUser: 0
          runAsNonRoot: false
          allowPrivilegeEscalation: true
          readOnlyRootFilesystem: false
          seccompProfile:
            type: Unconfined
          capabilities:
            drop:
              - ALL
            add:
              - SYS_ADMIN
              - SYS_CHROOT
              - SYS_PTRACE
        env:
        # Required credentials from Secret
        - name: ACTIVATION_ID
          valueFrom:
            secretKeyRef:
              name: {{ include "qualys-ca.secretName" . }}
              key: ACTIVATION_ID
        - name: CUSTOMER_ID
          valueFrom:
            secretKeyRef:
              name: {{ include "qualys-ca.secretName" . }}
              key: CUSTOMER_ID

        # Required configuration from ConfigMap
        - name: SERVER_URI
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: SERVER_URI
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: LOG_LEVEL

        # Optional logging settings
        {{- if .Values.config.logFileDir }}
        - name: LOG_FILE_DIR
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: LOG_FILE_DIR
        {{- end }}
        {{- if .Values.config.logDestType }}
        - name: LOG_DEST_TYPE
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: LOG_DEST_TYPE
        {{- end }}
        {{- if .Values.config.logCompression }}
        - name: LOG_COMPRESSION
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: LOG_COMPRESSION
        {{- end }}

        # Performance settings
        {{- if .Values.config.cmdMaxTimeOut }}
        - name: CMD_MAX_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: CMD_MAX_TIMEOUT
        {{- end }}
        {{- if .Values.config.processPriority }}
        - name: PROCESS_PRIORITY
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: PROCESS_PRIORITY
        {{- end }}
        {{- if .Values.config.scanDelayVM }}
        - name: SCAN_DELAY_VM
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: SCAN_DELAY_VM
        {{- end }}
        {{- if .Values.config.scanDelayPC }}
        - name: SCAN_DELAY_PC
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: SCAN_DELAY_PC
        {{- end }}
        {{- if .Values.config.maxRandomScanIntervalVM }}
        - name: MAX_RANDOM_SCAN_INTERVAL_VM
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: MAX_RANDOM_SCAN_INTERVAL_VM
        {{- end }}
        {{- if .Values.config.maxRandomScanIntervalPC }}
        - name: MAX_RANDOM_SCAN_INTERVAL_PC
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: MAX_RANDOM_SCAN_INTERVAL_PC
        {{- end }}

        # Permission settings
        {{- if .Values.config.useSudo }}
        - name: USE_SUDO
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: USE_SUDO
        {{- end }}
        {{- if .Values.config.sudoCommand }}
        - name: SUDO_COMMAND
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: SUDO_COMMAND
        {{- end }}
        {{- if .Values.config.user }}
        - name: AGENT_USER
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: AGENT_USER
        {{- end }}
        {{- if .Values.config.group }}
        - name: AGENT_GROUP
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: AGENT_GROUP
        {{- end }}

        # Other settings
        {{- if .Values.config.useAuditDispatcher }}
        - name: USE_AUDIT_DISPATCHER
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: USE_AUDIT_DISPATCHER
        {{- end }}
        {{- if .Values.config.hostIdSearchDir }}
        - name: HOST_ID_SEARCH_DIR
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: HOST_ID_SEARCH_DIR
        {{- end }}

        # Proxy settings from ConfigMap
        {{- if .Values.proxy.qualysProxyOrder }}
        - name: QUALYS_PROXY_ORDER
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: QUALYS_PROXY_ORDER
        {{- end }}
        {{- if .Values.proxy.proxyFailOpen }}
        - name: PROXY_FAIL_OPEN
          valueFrom:
            configMapKeyRef:
              name: {{ include "qualys-ca.fullname" . }}-config
              key: PROXY_FAIL_OPEN
        {{- end }}

        # Proxy URLs from Secret
        {{- if .Values.proxy.qualysHttpsProxy }}
        - name: QUALYS_HTTPS_PROXY
          valueFrom:
            secretKeyRef:
              name: {{ include "qualys-ca.secretName" . }}
              key: QUALYS_HTTPS_PROXY
        {{- end }}
        {{- if .Values.proxy.httpsProxy }}
        - name: HTTPS_PROXY
          valueFrom:
            secretKeyRef:
              name: {{ include "qualys-ca.secretName" . }}
              key: HTTPS_PROXY
        {{- end }}
        {{- if .Values.proxy.caCertBundle }}
        - name: CA_CERT_BUNDLE
          valueFrom:
            secretKeyRef:
              name: {{ include "qualys-ca.secretName" . }}
              key: CA_CERT_BUNDLE
        {{- end }}

        # Kubernetes metadata
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace

        volumeMounts:
        - name: host-tmp
          mountPath: /host/tmp
        - name: host-etc
          mountPath: /host/etc
        - name: host-var
          mountPath: /host/var
        - name: host-usr
          mountPath: /host/usr
        - name: host-opt
          mountPath: /host/opt
        - name: host-lib
          mountPath: /host/lib
        - name: host-lib64
          mountPath: /host/lib64
        - name: host-run
          mountPath: /host/run
        - name: host-proc
          mountPath: /host/proc
          readOnly: true
        - name: host-sys
          mountPath: /host/sys
          readOnly: true
        - name: host-bin
          mountPath: /host/bin
          readOnly: true
        - name: host-sbin
          mountPath: /host/sbin
          readOnly: true
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        livenessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - "test -S /host/run/systemd/private && cat /host/proc/1/comm >/dev/null 2>&1"
          initialDelaySeconds: 120
          periodSeconds: 60
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - "test -f /host/etc/qualys/cloud-agent/qualys-cloud-agent.conf"
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 5
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/bash
              - -c
              - "nsenter --target 1 --mount --uts --ipc --net --pid -- systemctl stop qualys-cloud-agent 2>/dev/null || true"
      volumes:
      - name: host-tmp
        hostPath:
          path: /tmp
          type: Directory
      - name: host-etc
        hostPath:
          path: /etc
          type: Directory
      - name: host-var
        hostPath:
          path: /var
          type: Directory
      - name: host-usr
        hostPath:
          path: /usr
          type: Directory
      - name: host-opt
        hostPath:
          path: /opt
          type: DirectoryOrCreate
      - name: host-lib
        hostPath:
          path: /lib
          type: Directory
      - name: host-lib64
        hostPath:
          path: /lib64
          type: DirectoryOrCreate
      - name: host-run
        hostPath:
          path: /run
          type: Directory
      - name: host-proc
        hostPath:
          path: /proc
          type: Directory
      - name: host-sys
        hostPath:
          path: /sys
          type: Directory
      - name: host-bin
        hostPath:
          path: /bin
          type: Directory
      - name: host-sbin
        hostPath:
          path: /sbin
          type: Directory
      restartPolicy: Always
      dnsPolicy: ClusterFirst
      terminationGracePeriodSeconds: 30
